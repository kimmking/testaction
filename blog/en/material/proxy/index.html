<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta http-equiv="Cache-Control" content="max-age=7200" />
    <meta name="generator" content="Hugo 0.70.0" />
    <meta name="description" content="">
    <meta name="buildDate" content="2020-08-06 10:42:53">


    <link rel="shortcut icon" href="https://shardingsphere.apache.org/document/current/img/favicon.png" type="image/x-icon" />

    <title>Revealing Sharding-Proxy —— Database Middleware Oriented DBA :: ShardingSphere</title>
    
    
    <link href="https://shardingsphere.apache.org/blog/css/nucleus.css?1596710573" rel="stylesheet">
    <link href="https://shardingsphere.apache.org/blog/css/font-awesome.min.css?1596710573" rel="stylesheet">
    <link href="https://shardingsphere.apache.org/blog/css/hybrid.css?1596710573" rel="stylesheet">
    <link href="https://shardingsphere.apache.org/blog/css/featherlight.min.css?1596710573" rel="stylesheet">
    <link href="https://shardingsphere.apache.org/blog/css/perfect-scrollbar.min.css?1596710573" rel="stylesheet">
    <link href="https://shardingsphere.apache.org/blog/css/auto-complete.css?1596710573" rel="stylesheet">
    <link href="https://shardingsphere.apache.org/blog/css/theme.css?1596710573" rel="stylesheet">
    <link href="https://shardingsphere.apache.org/blog/css/hugo-theme.css?1596710573" rel="stylesheet">
    
      <link href="https://shardingsphere.apache.org/blog/css/theme-black.css?1596710573" rel="stylesheet">
    

    <script src="https://shardingsphere.apache.org/blog/js/jquery-2.x.min.js?1596710573"></script>
    
    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{ 
          display:none !important;
      }
      
    </style>
    

  </head>
  <body class="" data-url="/en/material/proxy/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a href="https://shardingsphere.apache.org/"><img src="https://shardingsphere.apache.org/document/current/img/logo_v2.png" /></a>

    </div>
    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/en/material/" title="Article Selections" class="dd-item 
        parent
        
        
        ">
      <a href="https://shardingsphere.apache.org/blog/en/material/">
          Article Selections
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/material/elasticjob/" title="News! The distributed scheduling project ElasticJob set sail again" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/elasticjob/">
        News! The distributed scheduling project ElasticJob set sail again
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/graduate/" title="Congratulations on graduation of Apache ShardingSphere as a Top-Level Project!" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/graduate/">
        Congratulations on graduation of Apache ShardingSphere as a Top-Level Project!
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/database/" title="How to construct the distributed database" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/database/">
        How to construct the distributed database
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/community/" title="Exploration and expansion of the community" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/community/">
        Exploration and expansion of the community
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/cncf/" title="Apache ShardingSphere is included in CNCF Landscape" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/cncf/">
        Apache ShardingSphere is included in CNCF Landscape
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/seata/" title="Seata_AT" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/seata/">
        Seata_AT
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/solution/" title="The mixed open-source distributed transaction solution" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/solution/">
        The mixed open-source distributed transaction solution
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/committer/" title="Would you like to become an Apache committer" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/committer/">
        Would you like to become an Apache committer
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/engine/" title="How automatic executor of ShardingSphere works" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/engine/">
        How automatic executor of ShardingSphere works
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/result/" title="How to merge the child resultsets" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/result/">
        How to merge the child resultsets
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/realization/" title="The quick explanation of ShardingSphere transaction module" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/material/realization/">
        The quick explanation of ShardingSphere transaction module
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/material/proxy/" title="Revealing Sharding-Proxy —— Database Middleware Oriented DBA" class="dd-item active">
        <a href="https://shardingsphere.apache.org/blog/en/material/proxy/">
        Revealing Sharding-Proxy —— Database Middleware Oriented DBA
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/en/videos/" title="Video Selections" class="dd-item 
        
        
        
        ">
      <a href="https://shardingsphere.apache.org/blog/en/videos/">
          Video Selections
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/en/videos/opensource/" title="Getting started with Apache ShardingSphere" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/videos/opensource/">
        Getting started with Apache ShardingSphere
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/videos/build/" title="How to develop ShardingSphere community with Apache way" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/videos/build/">
        How to develop ShardingSphere community with Apache way
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/videos/new_sql/" title="Exploring Apache ShardingSphere with the perspective of new SQL" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/videos/new_sql/">
        Exploring Apache ShardingSphere with the perspective of new SQL
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/videos/evolution/" title="Apache ShardingSphere architecture evolution driven by open source" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/videos/evolution/">
        Apache ShardingSphere architecture evolution driven by open source
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/en/videos/ecosystem/" title="How to build database ecosystem with newSQL in a big-data environment" class="dd-item ">
        <a href="https://shardingsphere.apache.org/blog/en/videos/ecosystem/">
        How to build database ecosystem with newSQL in a big-data environment
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="prefooter">
      <hr/>
      <ul>
      
        <li>
          <a class="padding">
            <i class="fa fa-fw fa-language"></i>
          <div class="select-style">
            <select id="select-language" onchange="location = this.value;">
          
          
          
              
              
                  
                    
                    
<option id="en" value="/blog/en/material/proxy/" selected>English</option>
                    
                  
              
                  
              
          
              
              
                  
              
                  
                    
                    
<option id="cn" value="/blog/cn/material/proxy/">简体中文</option>
                    
                  
              
          
        </select>
        <svg version="1.1" id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
          width="255px" height="255px" viewBox="0 0 255 255" style="enable-background:new 0 0 255 255;" xml:space="preserve">
          <g>
            <g id="arrow-drop-down">
              <polygon points="0,63.75 127.5,191.25 255,63.75 		" />
            </g>
          </g>
        </svg>
        </div>
        </a>
        </li>
       
      
      
      </ul>
    </section>
    
    <section id="footer">
      <p></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fa fa-bars"></i>
                        </a>
                    </span>
                  
                  <span class="links">
                    
          
          
            
            
          
          
            
            
          
          
            <a href='https://shardingsphere.apache.org/blog/en/'>ShardingSphere</a> > <a href='https://shardingsphere.apache.org/blog/en/material/'>Article Selections</a> > Revealing Sharding-Proxy —— Database Middleware Oriented DBA
          
         
          
         
          
           
                  </span>
                </div>
                
              </div>
            </div>
            

        
          <div id="chapter">
        
        <div id="body-inner">
          

        


<nav id="TableOfContents">
  <ul>
    <li><a href="#revealing-sharding-proxy--database-middleware-oriented-dba">Revealing Sharding-Proxy —— Database Middleware Oriented DBA</a>
      <ul>
        <li><a href="#lecturer-introduction">Lecturer introduction</a></li>
        <li><a href="#01-sharding-proxy-introduction">01 Sharding-Proxy Introduction</a></li>
        <li><a href="#02-preparedstatement-achievement">02 PreparedStatement Achievement</a></li>
        <li><a href="#03-summary">03 Summary</a></li>
        <li><a href="#qa">Q&amp;A</a></li>
        <li><a href="#link-of-live-playback">Link of Live playback</a></li>
      </ul>
    </li>
  </ul>
</nav>

<h2 id="revealing-sharding-proxy--database-middleware-oriented-dba">Revealing Sharding-Proxy —— Database Middleware Oriented DBA</h2>
<h3 id="lecturer-introduction">Lecturer introduction</h3>
<p><strong>Yonglun Zhang</strong>: Senior software engineer of operation and maintenance department at JD Finance</p>
<p>He has been working on software development for years engaged in traditional Industry.  Afterwards he was involved in Internet and started his crawler career at JD Finance, sigh at the huge amount of Internet data since then. It&rsquo;s great honor to join Sharding-Sphere this year and be able to do what he is interested in, he hopes to improve himself and contribute to the community.</p>
<p>Hello everyone, I&rsquo;m so glad to show you Sharding-Proxy, which is the second product of Sharding-Sphere.</p>
<p>It was first released with Sharding-Sphere 3.0.0.M1 last month. I hope you can have visualize of overall view for Sharding-Proxy through several optimizing practices. With regard to topics of MySQL protocol, IO, Netty, etc. I&rsquo;ll share related themes when having an opportunity.</p>
<h3 id="01-sharding-proxy-introduction">01 Sharding-Proxy Introduction</h3>
<h4 id="1-sharding-proxy-overview">1. Sharding-Proxy Overview</h4>
<p>ShardingSphere-Proxy defines itself as a transparent database proxy, providing a database server that encapsulates database binary protocol to support heterogeneous languages. Friendlier to DBA, the MySQL version provided now can use any kind of terminal (such as MySQL Command Client, MySQL Workbench, etc.) that is compatible of MySQL protocol to operate data.</p>
<ul>
<li>
<p>Totally transparent to applications, it can be used directly as MySQL.</p>
</li>
<li>
<p>Applicable to any kind of terminal that is compatible with MySQL and PostgreSQL protocol.</p>
</li>
</ul>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy1.jpg" alt=""></p>
<p>Comparison with Sharding-JDBC &amp; Sharding-Sidecar:</p>
<p><img src="https://shardingsphere.apache.org/blog/img/comparsion_en.jpg" alt=""></p>
<p>They can work individually and cooperate each other, which achieve same purpose through different architecture and point of penetration. Its core functions are based on same implementation, such as data sharding, read-write splitting and base transaction.</p>
<p>For instance, Sharding-JDBC highly supports many kinds of ORM framework for Java development technology stack scenarios. It&rsquo;s quite convenient to import data sharding ability to your system. DBA retrieves and manages data by deploying a Sharding-Proxy instance.</p>
<h4 id="2-sharding-proxy-architecture">2. Sharding-Proxy Architecture</h4>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy_architecture1_en.jpg" alt=""></p>
<p>The whole architecture can be divided into three components: Frontend, Core-module and Backend:</p>
<ul>
<li>
<p>Frontend: It&rsquo;s responsible for communication with client, based on NIO client/server framework.  It adopts to NIO on Windows and Mac, adaptive to Epoll automatically on Linux, and completes to the encoding/decoding of MySQL protocol in the process of communication.</p>
</li>
<li>
<p>Core-module: After getting decoded command of MySQL, it starts to parse/rewrite/route/conflate sql through Sharding-Core.</p>
</li>
<li>
<p>Backend:  it&rsquo;s interacted with real database by Hikari pool of BIO. Its performance declines on condition of one master more slaves or large scale to database cluser in the way of BIO, so we will provide way of NIO to connect real database in the future.</p>
</li>
</ul>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy_architecture1_en.jpg" alt=""></p>
<p>The throughput of proxy will be greatly improved, which can effectively cope with large-scale database cluser in this way.</p>
<h3 id="02-preparedstatement-achievement">02 PreparedStatement Achievement</h3>
<h4 id="1-preparedstatement-achievement">1. PreparedStatement Achievement</h4>
<p>My first assignment at Sharding-Sphere is to achieve PreparedStatement of Proxy. It&rsquo;s said to be a flawless functionality that is precompile SQL to improve query speed and prevent SQL injection attacks. It sounds great that one precompilation and more queries reduces SQL compilation cost and lifts efficiency, but it turns out to be very slow to execute SQL, even it is slower than the original statement.</p>
<p>Neglect Proxy, let&rsquo;s see how MySQL protocol works when running PreparedStatement by wireshark.</p>
<p>Code sample as below:</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy5.jpg" alt=""></p>
<p>It&rsquo;s clear that perform query twice by PreparedStatement and set param user_id=10 each time. Through analysis of caught packets, protocol messages between JDBC and MySQL are as follows:</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy6.jpg" alt=""></p>
<p>JDBC executes query two times towards MySQL and MySQL returns results with the same times. We don&rsquo;t expect first message for PreparedStatement because of no question mark. It implies no effect to prepare, doesn&rsquo;t work for MySQL at least.</p>
<p>For the issue I think everyone makes sense without setting useServerPrepStmts=true to JDBC url. MySQL do prepare through the param. It&rsquo;s pointless if you don&rsquo;t set it although JDBC wants to perform preparation, because it is insensible to MySQL. Let&rsquo;s set the param in the url next:</p>
<pre><code>jdbc:mysql://127.0.0.1:3306/demo_ds?useServerPrepStmts=true
</code></pre><p>Here is the new interaction:</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy7.jpg" alt=""></p>
<p>It&rsquo;s a correct procedure at the first sight: for the first message, it&rsquo;s PreparedStatement which has question mark within SELECT; for the second message, MySQL points out to get ready for JDBC; for the third message, JDBC sets user_id=10; for the fourth message, MySQL returns query result; for the fifth messge, why does JDBC send PreparedStatement once more?</p>
<p>Each query should transfers its value of param through ExecuteStatement in expectation, then it takes effect of one precompilation and more performation.</p>
<p>If &ldquo;precompiling&rdquo; every time, there is no difference with normal query in addition to cost of two passing message: Response(prepareok) and ExecuteStatement(parameter=10). Here is the performance issue.</p>
<p>It shoud be something wrong if precompilation doesn&rsquo;t work. I read source code of JDBC in order to work it out, and find a important settting - cachePrepStmts. What will happen to set it:</p>
<pre><code>jdbc:mysql://127.0.0.1:3306/demo_ds?
useServerPrepStmts=true&amp;cachePrepStmts=true
</code></pre><p>We get the expected message flow. The speed is much faster than normal query after test.</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy8.jpg" alt=""></p>
<p>At the beginning of fifth message, it&rsquo;s enough to transfers value of param for each query. We reach the goal of one precompilation and more performation in the final, MySQL efficiency improves a lot. Due to shorter length of message, network IO efficiency is much better.</p>
<p>That is how &ldquo;cachePrepStmts=true&rdquo; works: JDBC cache needs prepared SQL. Here is an example of &ldquo;SELECT*FROMt_orderWHEREuser_id=?&quot;, after running once, it skips PreparedStatement next time and make use of ExecuteStatement to set param value.</p>
<p>when making it clear, you will know how to optimize Proxy. Proxy adops Hikari as database connecting pool. In time of initialization, it will set two params above.</p>
<pre><code>config.addDataSourceProperty(&quot;useServerPrepStmts&quot;,&quot;true&quot;);
config.addDataSourceProperty(&quot;cachePrepStmts&quot;,&quot;true&quot;);
</code></pre><p>These settings ensoure performance between Proxy and MySQL, but how does Proxy guarantee capability with Client?</p>
<p>When getting PreparedStatement from Client, Proxy doesn&rsquo;t send the message to MySQL due to question mark of sharding key in SQL, it has no idea which physical database to route to. It caches SQL only after getting those messages and makes StatementId stored into Map of SQL. It sends requests in the end when getting ExecuteStatement.</p>
<p>Before optimization, the logic works correctly. On account of each query, a new PreparedStatement cames into being and ExecuteStatement passes the type and value of param to Client.</p>
<p>It&rsquo;s different in message content afer adding two params above, there is no type but value for param when ExecuteStatement sends message second time, Proxy can&rsquo;t get param value without its type. So what to do for Proxy is that cache the type in the beginning.</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy9.jpg" alt=""></p>
<p>The image above shows interaction between Client and Proxy-MySQL when finishing optimization. From step 9, efficient query occurs.</p>
<h4 id="2-configuration-optimization-of-hikari">2. Configuration optimization of Hikari</h4>
<p>During initialization, Proxy will configure a Hariki pool for each pythsical database. According to sharding rule, SQL is route to real database, and get results through Hikari connection, Proxy conflates result and return it to client in the end. What&rsquo;s the size of database pool? As opinions vary, i&rsquo;ll give the final conclusion today.</p>
<p>Out of expectation, you will find it&rsquo;s not question about maximum in the opposite of minimum! Will you feel surprise that serial is faster than parallel when triggering a task?</p>
<p>Even single core cpu supports hundreds of threads at the same time, we know it&rsquo;s a &ldquo;time&rdquo; trick of operating system. In fact, a cpu only performs a thread a time and it triggers next thread when operating system switches context, so it goes back and forth.</p>
<p>Basic principle of CPU calculation is that it is always much faster to execute tasks A and B sequentially than to run them at the same time. In case count of threads is greater than CPU cores, it will be slower, but not faster. A test to Oracle confirms the opition.</p>
<p>Reference Link:</p>
<p><a href="http://www.dailymotion.com/video/x2s8uec">http://www.dailymotion.com/video/x2s8uec</a></p>
<p>Pool size is decreased from 2048 to 96, TPS is up to 20702 from 16163, average of response is decreased from 110ms to 3ms.</p>
<p>It&rsquo;s not easy to make counts of connection equal with CPU, we have to take IO of network/disk into consideration. When IO occurs and thread is blocked, operation system will assign free cpu to other threads. If thread is always blocked at I/O , we could set a little more of connection than CPU, then perform more tasks within the same time, but what shoud value be? PostgreSQL does a benchmark test:</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy10.jpg" alt=""></p>
<p>Increased speed of TPS starts to be slow from 50. According to the result, PostgreSQL gives the following formula:</p>
<pre><code>connections=((core_count*2)+effective_spindle_count)
</code></pre><p>connection count = ((cores*2)+ count disk).  60 connections is enough at a 32 core machine. so there is no need to set hundreds of connections for Proxy, it&rsquo;s not only wastes resources, but also slows down the speed.</p>
<h4 id="3--optimization-of-resultset-conflation">3.  Optimization of resultset conflation</h4>
<p>Proxy communicates with real database by JDBC at present, asynchronous access mode of Netty+MySQLProtocol will be released soon. They will coexist, which way to choose depends on client.</p>
<p>JDBC&rsquo;s resultset in Proxy can cause great memory pressure.  Proxy frontend links to m clients and its backend links to n physical databases though, when backend transfers data to client in the front, these data will store into Proxy memory. If those data stays long time, there will be no memory left and service will be unavailable in the end. Resultset memory efficiency can be optimized in two ways: one way is to reduce data residence time in proxy; the other is current limiting.</p>
<p>Let&rsquo;s see how it behaves before optimization. 5 clients link to Proxy, each one queries 150000 data. result is as follows:</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy11.jpg" alt=""></p>
<p>Memory of Proxy increases all the time, although GC is triggered. The reason is that ResultSet will be blocked next() until all the quering datas storing into memory. It&rsquo;s default way for ResultSet to retrieve data.</p>
<p>Is there any way to consume data immediately when ResultSet getting an item? Here is description in the Connector/J document:</p>
<pre><code>If you are working with ResultSets that have a large number of rows or large values and cannot allocate heap space in your JVM for the memory required , you can tell the driver to stream the results back one row at a time.

</code></pre><p>Link reference:</p>
<p><a href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-implementation-notes.html">https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-implementation-notes.html</a></p>
<p>To activate the ability, you only need to set a parameter when creating the statement instance:</p>
<pre><code>stmt.setFetchSize(Integer.MIN_VALUE);
</code></pre><p>You make it. Proxy consumes data at once by next() after querying the instruction, these data will be clean up at next GC. During resultset conflation, we also need to merge data in time, there is need to merge after retrieving them all, Sharding-Core provieds the interface. Here is the optimized result, figure1 below:</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy12.jpg" alt=""></p>
<p>Data in the memory stays shorter, GC recycles data each time, memory efficiency improves a lot. It seems we are crowned with success, but issues are deep in, follow with me to figure them out. The expected situation where the speed of data consumption from Client is faster than the one from Proxy at figure2.</p>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy13.jpg" alt=""></p>
<p>What  happens for Proxy to consumps data slower or not to work? From my test, memory usage increases linearly, stronger than figure1, Proxy is KO finally when it runs out of memory.</p>
<p>Let&rsquo;s analyze the reason, and then i&rsquo;ll introduce second optimization: Current limiting</p>
<p>Main settings about cache as follows::</p>
<ul>
<li>
<p>SO_RCVBUF/SO_SNDBUF is for TCP cache；</p>
</li>
<li>
<p>ChannelOutboundBuffer is for Netty writing cache.</p>
</li>
</ul>
<p><img src="https://shardingsphere.apache.org/blog/img/proxy14.jpg" alt=""></p>
<p>When Client is blocked, its SO_RCVBUF runs out instantly, then it notifies Proxy not to send data any more by slide window, SO_SNDBUF of Proxy is filled by Netty immediatelly at the same time.</p>
<p>ChannelOutboundBuffer of Netty swallows all the data from MySQL when SO_SNDBUF is up to top value, because it is unbounded by default.</p>
<p>SO_RCVBUF of Proxy has free memory due to Netty consumption, it causes MySQL sending data all the time, Netty always fills data into ChannelOutboundBuffer where to lead to serious results - no memory left.</p>
<p>When making it clear, our purpose is that Proxy will not accept MySQL data if Client is blocked.</p>
<p>Netty controls writting cache through WRITE_BUFFER_WATER_MARK param:</p>
<ul>
<li>
<p>when Buffer size is up to high watermark, Netty will not produce data any more, unless it&rsquo;s under low watermark;</p>
</li>
<li>
<p>Proxy implies MySQL not to send data if SO_RCVBUF is filled with after ChannelOutboundBuffer run out.</p>
</li>
</ul>
<p>So the key of the issue is its value for ChannelOutboundBuffer high watermark. On the condition Proxy consumes its memory based on high watermark of ChannelOutboundBuffer.</p>
<h4 id="4-proxy-modes">4. Proxy Modes</h4>
<p>There will be two agent modes configuration in the upcoming version of sharding-sphere 3.0.0.m2:</p>
<ul>
<li>
<p>MEMORY_STRICTLY: Proxy keeps all connections of database routed to, it&rsquo;s a good way to make use of ResultSet flow to conserve memory.</p>
</li>
<li>
<p>CONNECTION_STRICTLY: Agent releases connections when getting all of data from ResultSet, then its memory increases more then before.</p>
</li>
</ul>
<p>Let&rsquo;s make it simple, set MEMORY_STRICTLY mode if you want less consumption of memory; set CONNECTION_STRICTLY mode if you want less consumption of connections.</p>
<p>We have analyzed MEMORY_STRICTLY principle before, it also has side effect that ResultSet flow needs to keep database connection, after creating real connection where to route to all of physical tables, it could merge data instantly and return results to client.</p>
<p>Suppose that a database is set to max_user_connections=80, and it is routed to 100 tables resulting in being impossible to create 100 connections in the same time and no merging result to return.</p>
<p>In order to resolve the problem above, CONNECTION_STRICTLY comes out, it doesn&rsquo;t make use of ResultSet flow which causes memory increasing. CONNECTION_STRICTLY doesn&rsquo;t need to keep in touch with database, it will release connection after retrieving all the data in ResultSet.</p>
<p>We use the same setting max_user_connections=80 as example, the database is routed to 100 tables. Proxy create 80 connection for quering data at first, the other 20 connections will be cached into pool. These 20 connections will be created successfully one after another within quering completion before.</p>
<p>If you feel confused, please keep it in mind CONNECTION_STRICTLY is a scenario that max_user_connections is less than maximums of tables routed to.</p>
<h3 id="03-summary">03 Summary</h3>
<p>Sharding-Sphere has been continuous improvement and development since 2016. A growing number of componies and individuals adaop it, and they provide many successful cases for us.  We will move forward to impove current features, achieve soft transaction, data governance and so on in succession. If someone has good ideas or wants to do proposals, welcome to join Sharding-Sphere open source project.</p>
<ul>
<li>
<p><a href="https://github.com/sharding-sphere/sharding-sphere/">https://github.com/sharding-sphere/sharding-sphere/</a></p>
</li>
<li>
<p><a href="https://gitee.com/sharding-sphere/sharding-sphere/">https://gitee.com/sharding-sphere/sharding-sphere/</a></p>
</li>
</ul>
<h3 id="qa">Q&amp;A</h3>
<p>Q1: What&rsquo;s Sidecar?</p>
<p>A1: Sharding-Sidecar is the third product of Sharding-Sphere, it&rsquo;s on the way. It&rsquo;s in form of DaemonSet to agent all the databases targeted at cloud native database proxy.</p>
<p>Q2: Is it correct that &ldquo;please keep it in mind CONNECTION_STRICTLY is a scenario that max_user_connections is less than maximums of tables routed to&rdquo;？</p>
<p>A2: CONNECTION_STRICTLY is for decreasing connections. It&rsquo;s small for max_user_connections, so we use CONNECTION_STRICTLY mode.</p>
<p>Q3: Within the &ldquo;stmt.setFetchSize(custom_size)&rdquo; scenario, it&rsquo;s similar with ORM framworks like Mybatis to query a amount of datas into memory, these data are stored into list in general to handle them. They still occupy memory.</p>
<p>A3: It&rsquo;s client memory in this situation, it is no influence of Proxy.</p>
<p>Q4: If we have lots of data in memory, is it only one way to use native JDBC to query/handle datas every time without putting them into memory？</p>
<p>A4: Client takes control of Mybatis, it has nothing to do with Proxy.</p>
<h3 id="link-of-live-playback">Link of Live playback</h3>
<p><a href="https://m.qlchat.com/topic/details?topicId=2000001395952730&amp;minimal=1">https://m.qlchat.com/topic/details?topicId=2000001395952730&amp;minimal=1</a></p>
<p>Do you want to know more about Sharding-Sphere？</p>
<p><strong>Come to &ldquo;2018 DAMSChina Data Asset Management Summit&rdquo;</strong></p>
<p><strong>Attend the analysis of lecturer Zhang Liang who is responsible for database development of JD Finance</strong></p>


<footer class=" footline" >
	
</footer>


        
            </div> 
        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
        
        


        
            <a class="nav nav-prev" href="https://shardingsphere.apache.org/blog/en/material/realization/" title="The quick explanation of ShardingSphere transaction module"> <i class="fa fa-chevron-left"></i></a>
        
        
            <a class="nav nav-next" href="https://shardingsphere.apache.org/blog/en/videos/" title="Video Selections" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
        
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="https://shardingsphere.apache.org/blog/js/clipboard.min.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/perfect-scrollbar.min.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/perfect-scrollbar.jquery.min.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/jquery.sticky.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/featherlight.min.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/html5shiv-printshiv.min.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/highlight.pack.js?1596710573"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="https://shardingsphere.apache.org/blog/js/modernizr.custom.71422.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/learn.js?1596710573"></script>
    <script src="https://shardingsphere.apache.org/blog/js/hugo-learn.js?1596710573"></script>

    

  </body>
</html>

